#!/bin/bash

echo "üöÄ PhishingSense Database Setup & Diagnostics"
echo "============================================="

# Check environment configuration
echo "üìÑ Checking environment configuration..."
if [ -f ".env.local" ]; then
    echo "‚úÖ .env.local found"
    echo "üìã Supabase configuration:"
    grep -E "SUPABASE" .env.local || echo "‚ùå No Supabase variables found"
else
    echo "‚ùå .env.local not found!"
    echo "üìù Please create .env.local with:"
    echo "NEXT_PUBLIC_SUPABASE_URL=https://saxmpvvgjkidotpqsaht.supabase.co"
    echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNheG1wdnZnamtpZG90cHFzYWh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjQ2NTAsImV4cCI6MjA3Njk0MDY1MH0.Z05qOMiT_OnNLD3WwNxd-gTEwg1LRSwHDoYQOpq7vEY"
    exit 1
fi

echo ""
echo "üóÑÔ∏è  DATABASE SETUP INSTRUCTIONS:"
echo "================================="
echo "1. üåê Go to your Supabase project:"
echo "   https://supabase.com/dashboard/project/saxmpvvgjkidotpqsaht"
echo ""
echo "2. üìù Navigate to SQL Editor"
echo ""
echo "3. üìã Copy and paste the ENTIRE contents of supabase-schema.sql"
echo "   (File is in your project root directory)"
echo ""
echo "4. ‚ñ∂Ô∏è  Click 'Run' to execute the schema"
echo ""
echo "üìã What the schema creates:"
echo "‚Ä¢ users, scan_logs, reports, user_settings, patterns, comments tables"
echo "‚Ä¢ Row Level Security (RLS) policies for all tables"
echo "‚Ä¢ 150+ phishing detection patterns"
echo "‚Ä¢ Analytics functions and triggers"
echo "‚Ä¢ Proper indexes for performance"
echo ""
echo " If you get 'relation already exists' errors:"
echo "‚Ä¢ The schema has been partially applied before"
echo "‚Ä¢ Try running the schema again (it uses CREATE TABLE IF NOT EXISTS)"
echo "‚Ä¢ Or use ./reset-database.sh to start completely fresh"
echo ""
echo " ERROR CODE REFERENCE:"
echo "‚Ä¢ 42P01 = Tables don't exist (schema not run)"
echo "‚Ä¢ 42501 = Access denied (RLS policy issue)"
echo "‚Ä¢ 23505 = Duplicate entry (already exists)"
echo "‚Ä¢ 42P07 = Table already exists (schema partially applied)"
echo ""
echo " AFTER SETUP:"
echo "1. Restart your development server: pnpm dev"
echo "2. Try signing up with a test email"
echo "3. Check browser console for detailed error logs"
echo ""
echo " Alternative Setup Methods:"
echo "‚Ä¢ Use Supabase CLI: supabase db push"
echo "‚Ä¢ Manual verification: Check if tables exist in Supabase Dashboard"
echo ""
echo " Quick Fix for 'Already Exists' Errors:"
echo "Run this SQL first to drop existing tables:"
echo "DROP TABLE IF EXISTS public.users CASCADE;"
echo "DROP TABLE IF EXISTS public.scan_logs CASCADE;"
echo "DROP TABLE IF EXISTS public.reports CASCADE;"
echo "DROP TABLE IF EXISTS public.user_settings CASCADE;"
echo "DROP TABLE IF EXISTS public.patterns CASCADE;"
echo "DROP TABLE IF EXISTS public.comments CASCADE;"
echo ""
echo " After applying schema, visit http://localhost:3000"
echo "You should see the authentication interface working perfectly!"
